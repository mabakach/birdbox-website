<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head lang="de">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Birdbox Statistiken</title>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/birdbox.css" rel="stylesheet">
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/chart.js"></script>
<script src="/js/chartjs-adapter-date-fns.js"></script>
<!-- <script src="/js/birdbox.js"></script>  -->
</head>
<body>
    <!-- Header -->
    <div th:replace="fragments.html :: navbar"></div>

    <!-- Main Content -->
    <div class="container">
        <div class="row mt-4">
            <div class="col-12 text-center">
                <h1>Statistiken</h1>
                <div class="mb-3">
                    <label for="periodSelect" class="form-label">Zeitraum wählen:</label>
                    <select id="periodSelect" class="form-select w-auto d-inline-block">
                        <option value="day">Letzte 24 Stunden</option>
                        <option value="week">Letzte 7 Tage</option>
                        <option value="month">Letzte 30 Tage</option>
                        <option value="quarter">Letzte 90 Tage</option>
                    </select>
                </div>
                <div class="chart-container d-flex justify-content-center" style="position: relative; height:50vh; width:100%">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="fragments.html :: footer"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const measurementsData = {
            day: /*[[${measurementsDay}]]*/ [],
            week: /*[[${measurementsWeek}]]*/ [],
            month: /*[[${measurementsMonth}]]*/ [],
            quarter: /*[[${measurementsQuarter}]]*/ []
        };
        function toISODateString(sqlTimestamp) {
            // Converts 'YYYY-MM-DD HH:mm:ss.SSSSSS' to 'YYYY-MM-DDTHH:mm:ss.SSSSSS'
            if (typeof sqlTimestamp === 'string') {
                return sqlTimestamp.replace(' ', 'T');
            }
            return sqlTimestamp;
        }
        function getChartData(period) {
            const measurements = measurementsData[period] || [];
            function sanitizeNumber(val) {
                const num = Number(val);
                return isNaN(num) ? null : num;
            }
            if (period === 'day' || period === 'week') {
                return {
                    temperatureData: measurements.map(m => ({
                        x: toISODateString(m.measurementTimestamp),
                        y: sanitizeNumber(m.temperature)
                    })),
                    humidityData: measurements.map(m => ({
                        x: toISODateString(m.measurementTimestamp),
                        y: sanitizeNumber(m.humidity)
                    }))
                };
            } else {
                return {
                    temperatureData: measurements.map(m => ({
                        x: toISODateString(m.timestamp),
                        y: sanitizeNumber(m.avgTemperature)
                    })),
                    humidityData: measurements.map(m => ({
                        x: toISODateString(m.timestamp),
                        y: sanitizeNumber(m.avgHumidity)
                    }))
                };
            }
        }
        let currentPeriod = 'day';
        let chartInstance = null;
        function renderChart(period) {
            const {temperatureData, humidityData} = getChartData(period);
            const ctx = document.getElementById('statsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Temperatur (°C)',
                            data: temperatureData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            yAxisID: 'y',
                            tension: 0.2
                        },
                        {
                            label: 'Luftfeuchtigkeit (%)',
                            data: humidityData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            yAxisID: 'y1',
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'dd.MM.yyyy HH:mm',
                                displayFormats: {
                                    hour: 'dd.MM.yyyy HH:mm',
                                    minute: 'dd.MM.yyyy HH:mm',
                                    day: 'dd.MM.yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Zeit'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatur (°C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Luftfeuchtigkeit (%)'
                            }
                        }
                    }
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            renderChart(currentPeriod);
            document.getElementById('periodSelect').addEventListener('change', function(e) {
                currentPeriod = e.target.value;
                renderChart(currentPeriod);
            });
        });
        /*]]>*/
    </script>
</body>
</html>